<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sauvegarde Jeu</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
        }
        button:active {
            background: #2980b9;
        }
        h1 {
            color: #333;
        }
        #console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #f59e0b; }
    </style>
</head>
<body>
    <h1>üß™ Test Sauvegarde du Jeu</h1>
    
    <div class="test-box">
        <h2>Instructions:</h2>
        <p>Cette page teste la logique de sauvegarde exactement comme dans le jeu r√©el.</p>
        <ol>
            <li>Cliquez sur "Simuler Niveau Termin√©"</li>
            <li>Regardez la console ci-dessous</li>
            <li>V√©rifiez si "‚úÖ Game progress saved successfully" appara√Æt</li>
        </ol>
    </div>

    <div class="test-box">
        <button onclick="testLevelComplete()">üéÆ Simuler Niveau Termin√©</button>
        <button onclick="checkSavedData()">üìÇ V√©rifier Donn√©es Sauvegard√©es</button>
        <button onclick="clearConsole()">üóëÔ∏è Effacer Console</button>
        <button onclick="clearAllData()">‚ùå Effacer Toutes les Donn√©es</button>
    </div>

    <div class="test-box">
        <h2>üìã Console de Debug:</h2>
        <div id="console-output">Pr√™t √† tester...</div>
    </div>

    <!-- Load game scripts -->
    <script src="js/game-state.js"></script>
    <script src="js/hp-system.js"></script>
    <script src="js/timer.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Override console.log to display in page
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const consoleOutput = document.getElementById('console-output');

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'warn' ? 'info' : 'success';
            consoleOutput.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Also log to real console
            if (type === 'error') originalError(message);
            else if (type === 'warn') originalWarn(message);
            else originalLog(message);
        }

        console.log = function(...args) {
            addToConsole(args.join(' '), 'log');
        };

        console.warn = function(...args) {
            addToConsole('‚ö†Ô∏è ' + args.join(' '), 'warn');
        };

        console.error = function(...args) {
            addToConsole('‚ùå ' + args.join(' '), 'error');
        };

        function clearConsole() {
            consoleOutput.innerHTML = 'Console effac√©e...\n';
        }

        function testLevelComplete() {
            addToConsole('\n=== TEST D√âBUT ===', 'log');
            addToConsole('Simulation de niveau termin√©...', 'log');
            
            // Simulate game state
            currentLevel = {
                id: 'level_1',
                name: 'Test Level',
                numCharacters: 5
            };
            currentHP = 85;
            maxHP = 100;
            timerElapsedSeconds = 120;
            
            addToConsole('√âtat du jeu initialis√©:', 'log');
            addToConsole(`  Level: ${currentLevel.id}`, 'log');
            addToConsole(`  HP: ${currentHP}/${maxHP}`, 'log');
            addToConsole(`  Time: ${timerElapsedSeconds}s`, 'log');
            
            // Check if user exists
            addToConsole(`\nUtilisateur actuel: ${currentUser ? currentUser.name : 'AUCUN'}`, 'log');
            
            if (!currentUser) {
                addToConsole('Pas d\'utilisateur - appel de simulateGoogleLogin()...', 'log');
                simulateGoogleLogin();
                
                // Wait a bit then try to save
                setTimeout(() => {
                    if (currentUser) {
                        addToConsole(`‚úÖ Utilisateur cr√©√©: ${currentUser.name}`, 'log');
                        addToConsole('Appel de saveGameProgress()...', 'log');
                        saveGameProgress();
                    } else {
                        addToConsole('‚ùå √âCHEC: currentUser est toujours null!', 'error');
                    }
                }, 100);
            } else {
                addToConsole('Utilisateur d√©j√† connect√© - appel de saveGameProgress()...', 'log');
                saveGameProgress();
            }
            
            addToConsole('=== TEST FIN ===\n', 'log');
        }

        function checkSavedData() {
            addToConsole('\n=== V√âRIFICATION DONN√âES ===', 'log');
            
            const keys = ['gameProgress', 'gameProgress_Demo User'];
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    addToConsole(`\n‚úÖ Trouv√©: ${key}`, 'log');
                    try {
                        const parsed = JSON.parse(data);
                        addToConsole(JSON.stringify(parsed, null, 2), 'log');
                    } catch (e) {
                        addToConsole('Erreur de parsing JSON', 'error');
                    }
                } else {
                    addToConsole(`‚ùå Non trouv√©: ${key}`, 'warn');
                }
            });
            
            addToConsole('\n=== FIN V√âRIFICATION ===\n', 'log');
        }

        function clearAllData() {
            if (confirm('Effacer toutes les donn√©es de test?')) {
                localStorage.removeItem('gameProgress');
                localStorage.removeItem('gameProgress_Demo User');
                currentUser = null;
                addToConsole('üóëÔ∏è Toutes les donn√©es effac√©es', 'log');
            }
        }

        // Show initial state
        addToConsole('Page de test charg√©e', 'log');
        addToConsole(`localStorage disponible: ${typeof localStorage !== 'undefined' ? 'OUI' : 'NON'}`, 'log');
        addToConsole('Cliquez sur "Simuler Niveau Termin√©" pour commencer\n', 'log');
    </script>
</body>
</html>
